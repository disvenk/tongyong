$(document).ready(function(){var t=$("[data-tab='"+location.hash+"']");if(t.length<1){t=$("#ul-menu>li:eq(1)")}t.click();setTimeout(function(){window.onhashchange=function(){var t=location.hash.toString();if(t.indexOf(".hidem")!=-1){$("#ul-menu").hide();t=t.substring(0,t.indexOf(".hidem"))}else{$("#ul-menu").show();var e=$("#ul-menu>li[data-tab='"+t+"']");e.click()}$(".custom-dialog:not(.not-close)").hide()}},800)});homeInit();var informationIsc;$("#ul-menu>li").click(function(){var t=$(this).data("tab");$(".tab-content").find(".tab-subpage").removeClass("active");$(t).addClass("active");currentModeDiv=$(t);$(this).parent().find(".cur").removeClass("cur");$(this).addClass("cur");location.hash=t;var e=$(this).data("title");$("head>title").text(e)});var mySwiper=null;function homeBannerInit(){if(mySwiper){mySwiper.update()}if(homeIsc){homeIsc.refresh()}}function switchToInfo(){if(informationIsc){informationIsc.refresh()}informationInit()}function informationInit(){cAjax("wx/customerInfo","",function(t){currentCustomer=t;var e=t.TELEPHONE;$("#content-information").setAjaxParam(t);var i=new HashMap;$("*[data-state]").hide().each(function(t){var e=$(this).data("state");i.put(e,[])});loadChargeItems(function(){location.reload()});cAjax("wx/listOrder",null,function(t){for(var a in t.list){var r=t.list[a];var n=i.get(r.ORDER_STATE);if(n){n.push(r)}}for(var a in i.getKeys()){var o=i.getKeys()[a];var n=i.get(o);if(n.length>0){$("*[data-state='"+o+"']").show().html(n.length)}}var l=i.get(2);var c=[];for(var a in l){var d=l[a];var s=order2li(d,e);c.push(s)}var u=i.get(10);for(var a in u){var d=u[a];var s=order2li(d,e);c.push(s)}$("#order-list-state2").html(c);if(informationIsc){informationIsc.refresh()}})})}function cancelOrder(t){if(confirm("你确定要取消该订单吗？已支付金额及优惠将原路返还！")){var e=$(t).parents(".order-item").data("id");cAjax("wx/cancelOrder",{ORDER_ID:e},function(t){if(t.result=="01"){alert("取消成功")}else{alert(t.msg)}location.reload()})}}function homeInit(){cAjax("wx/server",{p:"/pictureslider/weixin/listPictureSlider"},function(t){var e=t.list;$("#pictureSlider").html("");for(var i in e){var a=e[i];var r=$("<div class='swiper-slide' style='text-align:center'></div>");var n=$("<img />");if(a.PICTURE_URL){n.attr("src",IMAGE_SERVICE+a.PICTURE_URL);r.html(n)}$("#pictureSlider").append(r)}if(e.length<=1){mySwiper=new Swiper(".swiper-container",{direction:"horizontal"})}else{mySwiper=new Swiper(".swiper-container",{direction:"horizontal",loop:true,autoplay:3e3,pagination:".swiper-pagination"})}});cAjax("wx/getShopInfo",null,function(t){var e=t.data;var i=e.ADDRESS;var a=$("#restaurant-info");a.find(".address").html(e.ADDRESS);a.find(".location-icon").click(function(){wxOpenLocation(e.LATITUDE,e.LONGITUDE,e.SHOP_DES,e.ADDRESS)});a.find(".restaurant-time").html(e.SHOP_OPEN_TIME+" - "+e.SHOP_CLOSE_TIME);a.find(".phone-a").attr("href","tel:"+e.TEL);a.find(".shop_des").html(e.SHOP_DES);$("#new-customer-notice").html(e.NEW_CUSTOMER_NOTICE);for(var r=0;r<e.AVG_LEVEL;r++){a.find(".starLevel").find(".iconfont").eq(r).addClass("star-cur")}var n=$("#restaurant-li");$("#content-tangshi").find(".restaurant-name-span").text(e.SHOP_DES);n.html(e.SHOP_DES);n.attr("data-addr",e.ADDRESS);n.attr("data-title",e.SHOP_DES);n.click(function(){if(tangshiMap){tangshiMap.toLocation(e.LATITUDE,e.LONGITUDE)}})});cAjax("wx/server",{p:"/advert/weixin/advertDetails"},function(t){var e=t.data;var i=$("#slogan-div");var a=$(e.DESCRIPTION);a.find("img").attr("style","width:100%;height:auto");a.find("img").each(function(){$(this).attr("src",IMAGE_SERVICE+$(this).attr("src"))});i.find(".slogan").html(e.SLOGAN);i.find(".description").html(a)});cAjax("wx/server",{p:"/appraise/weixin/appraiseCount"},function(t){var e=t.data.COUNT;var i=t.data.AVG_SCORE.toFixed(1);$("#score-span").html(i+"分");$("#appraise-count-span").html("("+e+"条"+" "+i+"分)")});cAjax("wx/server",{p:"/notice/weixin/listNotice"},function(t){var e=t.list;noticleList=e;$("#notice-dom").html("");for(var i in e){var a=e[i];var r=$("<li class='notice-li'>");r.html("<p>"+a.TITLE+"<i class='icon-chevron-right' style='float:right;color:#ccc'></i></p>");r.attr("data-title",a.TITLE);r.attr("data-content",a.CONTENT.replace(/\n/g,"<br/>"));r.attr("data-image",a.NOTICE_IMAGE);r.click(function(){var t=$("#notice-dialog");t.find(".image").attr("src",IMAGE_SERVICE+$(this).data("image"));t.find(".title").html($(this).data("title"));t.find(".content").html($(this).data("content"));t.show()});$("#notice-dom").append(r);if(a.NOTICE_TYPE==2){r.addClass("new-customer");r.hide()}}if(e.length<=0){$("#notice-dom").hide()}else{var n=Math.ceil(Math.random()*e.length)-1;$("#notice-dom").show()}})}var noticleList=new Array;var currentModeDiv;var DISTRIBUTION_MODE_ID=1;var NAME="堂吃";var articleListMap=new HashMap;var articlesMap=new HashMap;var shopCart=new ShopCart;var t_articleListMap=new HashMap;var t_articlesMap=new HashMap;var t_shopCart=new ShopCart;var w_articleListMap=new HashMap;var w_articlesMap=new HashMap;var w_shopCart=new ShopCart;var tangshiFamliyInit=true;function choiceTangshi(){if(tangshiFamliyInit){loadDistributionModeDiv()}else{currentModeDiv.find(".choice-div").hide();currentModeDiv.find(".article-div").show()}tangshiFamliyInit=false;smenu()}var tangShiInit=true;function switchToTangshi(){DISTRIBUTION_MODE_ID=1;NAME="堂吃";currentModeDiv=$("#content-tangshi");articleListMap=t_articleListMap;articlesMap=t_articlesMap;shopCart=t_shopCart;if(tangShiInit){tangShiInit=false;choiceTangshi()}if(currentModeDiv.find(".choice-div").is(":visible")){hmenu()}if(ismenushow()){currentModeDiv.find(".choice-div").hide();currentModeDiv.find(".payment-div").hide();currentModeDiv.find(".article-div").show()}initIsc()}var waimaiInit=true;var isclick=false;function switchToWaimai(){isclick=true;DISTRIBUTION_MODE_ID=2;NAME="外卖";currentModeDiv=$("#content-waimai");articleListMap=w_articleListMap;articlesMap=w_articlesMap;shopCart=w_shopCart;if(waimaiInit){waimaiPageInit();waimaiInit=false}if(ismenushow()){currentModeDiv.find(".payment-div").hide();currentModeDiv.find(".article-div").show();setTimeout(function(){if(!isChoiceLocation()){showLocationDialog()}else if(!getSelectDate()){showTimeDialog()}},50)}initIsc()}function returnToChoice(){currentModeDiv.find(".article-div").hide();currentModeDiv.find(".choice-div").show();hmenu()}function waimaiPageInit(){cAjax("wx/server",{p:"/deliverypoint/weixin/waimaiDelivery"},function(t){var e=t.list;var i=[];var a;for(var r in e){var n=e[r];var o=$("<li></li>");o.attr("data-deliveryid",n.DELIVERY_POINT_ID);o.attr("data-mapx",n.MAP_X);o.attr("data-mapy",n.MAP_Y);o.attr("data-title",n.NAME);o.attr("data-addr",n.DETAIL);o.html("<i class='icon-map-marker'></i>"+n.NAME+"<p>"+n.DETAIL+"</p>"+'<i class="icon-chevron-right"></i>');i.push(o);o.click(function(){$(this).parent().find(".active").removeClass("active");$(this).addClass("active");var t=$(this).data("mapx");var e=$(this).data("mapy");var i=$(this).data("title");var a=$(this).data("addr");if(waimaiMap){waimaiMap.toLocation(t,e)}})}$("#waimai-location-dialog").find(".foodList-content-center>ul").html(i)});setTimeout(function(){showLocationDialog()},50)}var deliveryTime="";var deliveryDay="";var deliveryPoint="";var deliveryName="";var waimaiArticleInit=true;function choiceWaimai(){}function showLocationDialog(){$("#waimai-location-dialog").show()}function choiceLocation(){if(!isChoiceLocation()){showMessage("请选择就餐位置")}else{$("#waimai-location-dialog").hide();showTimeDialog()}}function showTimeDialog(){loadDeliveryTime(function(t,e){var i=[];for(var a in t){var r=$("<li></li>");var n=new Date(t[a].DATE);var o=n.format("yyyy-MM-dd");var l=t[a].NAME;r.attr("data-date",o);r.html(o+" "+l);i.push(r)}$("#select-date-dialog .select-date ul").html(i);var c=[];for(var a in e){var r=$("<li></li>");var d=e[a].BEGIN_TIME;var s=e[a].STOP_ORDER_TIME;r.attr("data-id",e[a].DISTRIBUTION_TIME_ID);r.attr("data-time",d);r.attr("data-stoptime",s);r.html(d);c.push(r)}$("#select-date-dialog .select-time ul").html(c);$("#select-date-dialog .time-choice	li").click(function(){$(this).parent().find(".active").removeClass("active");$(this).addClass("active");var t=getSelectDate()})});$("#select-date-dialog").show()}function getSelectDate(){var t=$("#select-date-dialog .select-date li.active");if(t.length==0){return false}var e=$("#select-date-dialog .select-time li.active");if(e.length==0){return false}var i=e.data("id");var a=t.data("date").replace(/-/g,"/");var r=a+" "+e.data("time");r=new Date(r);var n=a+" "+e.data("stoptime");n=new Date(n);if(n<new Date){$("#select-date-dialog .confirm-time").html("请提前一小时点餐，已过点").prop("disabled",true);return false}else{$("#select-date-dialog .confirm-time").html("确定").prop("disabled",false)}r={day:t.data("date"),time:{id:i,time:e.data("time")}};return r}var deliveryDates;var deliveryTimes;function loadDeliveryTime(t){if(deliveryDates&&deliveryTimes){t&&t(deliveryDates,deliveryTimes)}else{cAjax("wx/waimaiTimes",null,function(e){deliveryDates=e.data.dates;deliveryTimes=e.list;t&&t(deliveryDates,deliveryTimes)})}}function loadWaimaiArticles(t){loadDistributionModeDiv(t)}function choiceTime(t){var e=getSelectDate();if(e){currentModeDiv.find(".delivery-name").html(deliveryName+new Date(e.day.replace(/-/g,"/")+" "+e.time.time).format("(MM-dd hh:mm)"));$("#select-date-dialog").hide();showMessage("正在加载外卖餐品");loadWaimaiArticles(e.day)}else{showMessage("请选择取餐时间");return false}}function isChoiceLocation(){var t=$("#waimai-location-dialog").find(".address-list li.active");if(t.length==0){return false}deliveryPoint=t.data("deliveryid");deliveryAddress=t.data("addr");deliveryName=t.data("title");currentModeDiv.find(".waimai-address .delivery-addr").html(deliveryAddress);return true}function createCoupon(t,e){var i=currentModeDiv.find(".coupon-li .accountAmount");var a=currentModeDiv.find("input.use_account").is(":checked");var r=$("<select></select>").css({width:"62%",border:0});for(var n in t){var o=t[n];if(e<o.MIN_AMOUNT){continue}if(a){if(o.COUPON_TYPE==1){r.append("<option value="+o.COUPON_ID+" data-value='"+o.VALUE+"'>"+o.VALUE+"元"+(o.NAME||"")+"</option>")}}else{r.append("<option value="+o.COUPON_ID+" data-value='"+o.VALUE+"'>"+o.VALUE+"元"+(o.NAME||"")+"</option>")}}if(!r.find("option").length){currentModeDiv.find(".coupon-li").hide()}else{currentModeDiv.find(".coupon-li").show();i.html(r);r.change(function(){updateTotalOrder()})}}function findCouponValue(t,e){for(var i in t){var a=t[i];if(a.COUPON_ID==e){return a.VALUE}}return 0}function showSingleArticle(t){var e=createShopCartItem(t);var i=e.find(".minusNumber").removeAttr("onclick");e.find(".art-number").html(0);i.click(function(){paymentCut(this,null,function(){showSingleArticle(t)})});e.find(".addNumber").click(function(){i.show()});$("#single-article-dialog").find(".single-item").html(e);$("#single-article-dialog").find(".confrim-payment").unbind();$("#single-article-dialog").find(".confrim-payment").click(function(){toPayment(true)});$("#single-article-dialog").show()}function getRichArt(){var t=articlesMap.getValues();var e=null;for(var i in t){var a=t[i];if(isRich(a.NAME)){e=a}}return e}function isRich(t){return t.match(/.*元气米饭.*/g)}var allAccountCoupon=new Array;function toPayment(t){if(shopCart.getAll().length<=0){showMessage("您还没有点餐哦！");return false}cAjax("wx/customerInfo",null,function(e){currentCustomer=e;if(!e.TELEPHONE){bindPhone("")}else{payFunction(t)}})}function payFunction(t){var e=shopCart.getAll();var i=false;for(var a in e){var r=e[a];if(isRich(r.NAME)){i=true}}if(!i&&!t){var n=getRichArt();if(n){showSingleArticle(n);return false}}if(DISTRIBUTION_MODE_ID==2){if(!isChoiceLocation()){showLocationDialog();return false}var o=getSelectDate();if(!o){showTimeDialog();return false}else{deliveryDay=o.day;deliveryTime=o.time.id}}$(".save-order").prop("disabled",false).html("买单");cAjax("wx/listCoupon",{STATUS:0,DISTRIBUTION_MODE_ID:DISTRIBUTION_MODE_ID},function(t){allAccountCoupon=t.list;currentModeDiv.find(".article-div").hide();hmenu(true);currentModeDiv.find(".payment-div").show().setAjaxParam(currentCustomer);var e=currentModeDiv.find(".payment-div").find(".shopcart-list");e.html(getShopCartItems());var i=getTmpl(".TotalOrder");currentModeDiv.find(".payment-div").find(".buyingConfirmDetails>.TotalOrder").remove();currentModeDiv.find(".payment-div").find(".buyingConfirmDetails").append(i);var a=shopCart.getTotalPrice();createCoupon(allAccountCoupon,a);updateTotalOrder();cAjax("wx/customerInfo",null,function(t){currentCustomer=t});t_PayListIsc.refresh();w_PayListIsc.refresh()});loadChargeItems(function(){toPayment(true)})}function loadChargeItems(t){cAjax("wx/server",{p:"/charge/weixin/rulesList"},function(e){console.log(currentModeDiv);var i=e.list;var a=currentModeDiv.find(".charge-btn");a.unbind();if(i.length>0){showToPayPage(i,t);a.click(function(){chargeDialogShow(i,t)});a.addClass("active")}else{a.removeClass("active")}console.log(e)})}function showToPayPage(t,e){currentModeDiv.find(".charge-btn-groups").html("");for(var i in t){var a=t[i];if(a.SHOW_IN){var r=$("<button class='direct-chrage-btn'>");r.text(a.LABEL_TEXT);r.attr("data-id",a.CHARGE_ID);r.click(function(){var t=$(this).data("id");chargeWxRequest(t,e)});currentModeDiv.find(".charge-btn-groups").append(r)}console.log(a)}}function chargeDialogShow(t,e){var i=$("#charge-dialog");var a=i.find(".charge-list");a.html("");for(var r in t){var n=t[r];var o=$('<input  type="radio" name="CHARGE_ID">');o.val(n.CHARGE_ID);o.attr("id",n.CHARGE_ID);var l=$("<label>");l.html(n.LABEL_TEXT);l.attr("for",n.CHARGE_ID);var c=$("<li class='weixin'>");c.append(o);l.append('<i class="iconfont"></i>');c.append(l);a.append(c)}if(t.length>0){var d=i.find(".confrim-charge");d.prop("disabled",false).html("充值");d.unbind();d.click(function(){var t=i.find("[type='radio']:checked").val();if(!t){showMessage("请选择充值金额");return false}else{d.prop("disabled",true).html("正在充值");chargeWxRequest(t,e)}});i.show()}}function chargeWxRequest(t,e){loading("body");cAjax("wx/chargeOrderWx",{CHARGE_ID:t},function(t){wx.chooseWXPay({timestamp:t.timeStamp,nonceStr:t.nonceStr,"package":t.prepay_id,signType:t.signType,paySign:t.paySign,success:function(t){alert("充值成功!");$("#charge-dialog").hide();currentOrder=null;e&&e()}});loaded("body")})}function getShopCartItems(){var t=[];for(var e in shopCart.getAll()){var i=shopCart.getAll()[e];var a=createShopCartItem(i);t.push(a)}return t}function createShopCartItem(t){var e=getTmpl(".shopcart-item");e.setAjaxParam(t);e.attr("data-id",t.ARTICLE_ID);return e}function btnTimeCount(t,e){if(e>0){$(t).html(e+"秒");$(t).prop("disabled",true);setTimeout(function(){btnTimeCount(t,e-1)},1e3)}else{$(t).html("获取验证码");$(t).prop("disabled",false)}}function bindPhone(t){var e=$("#welcome-dialog");e.show();e.find(".btn-code").unbind();e.find(".btn-code").click(function(){var i=e.find("[name='PHONE']").val();if(i==t){return true}else{sendMsg(i,this)}});e.find(".dialog-close").unbind();e.find(".dialog-close").click(function(){e.hide();history.go(-1)});e.find(".btn-submit").unbind();e.find(".btn-submit").click(function(){var i=this;$(i).prop("disabled",true);var a=e.find("[name='PHONE']").val();var r=e.find("[name='CODE']").val();if(a==t){return true}else{cAjax("wx/editPhone",{CODE:r,PHONE:a},function(t){if(t.result==1){e.hide();if(!currentCustomer.BIND_PHONE){$(".notice-li.new-customer").click()}toPayment(true)}else{e.find(".error").html(t.msg);e.find(".error").parent().show();$(i).removeAttr("disabled")}})}})}function sendMsg(t,e){$(e).html("正在发送").attr("disabled","disabled");cAjax("wx/sendCodeMsg",{PHONE:t},function(t){if(t.result=="01"){btnTimeCount(e,60)}else{$(e).html("手机格式错误").attr("disabled",false)}})}function useAccountChecked(){updateTotalOrder()}function updateTotalOrder(){currentOrder=null;var t=currentModeDiv.find(".TotalOrder");var e=shopCart.getTotalPrice();var i=e;t.find(".article-count-price").html(e);var a=currentModeDiv.find(".coupon-li:visible .accountAmount select option:selected").data("value");i-=a||0;if(i>0){var r=currentModeDiv.find(".use_account").is(":checked")?1:0;if(r){i-=currentCustomer.ACCOUNT}}else{currentModeDiv.find(".use_account").prop("checked",false)}i=i<0?0:i;changeTotalOrder(i)}function changeTotalOrder(t){currentModeDiv.find(".actually-pay").attr("data-money",t);currentModeDiv.find(".actually-pay").html(t.toFixed(2))}function saveOrder(t){$(t).prop("disabled",true).html("正在提交..");submitOrderForm(t)}function submitOrderForm(t){if(currentOrder){showPayDialog(currentOrder);$(t).html("买单").prop("disabled",false);return}var e={};e.customer_id=currentCustomer.CUSTOMER_ID;e.distribution_mode_id=DISTRIBUTION_MODE_ID;e.distribution_date=deliveryDay||null;e.distribution_time_id=deliveryTime||null;e.delivery_point_id=deliveryPoint||null;if(currentModeDiv.find(".coupon-li").is(":visible")){var i=currentModeDiv.find(".coupon-li select").val();e.coupon_id=i}var a=currentModeDiv.find(".use_account").is(":checked")?1:0;e.use_account=a;e.order_item_list=new Array;var r=shopCart.getAll();for(var n in r){var o=r[n];e.order_item_list.push({article_id:o.ARTICLE_ID,count:o.number})}var l=JSON.stringify(e);loading("body");cAjax("wx/saveOrder",{orderform:l},function(e){loaded("body");if(e.result=="01"){if(e.data.PAYMENT_AMOUNT==0){paySuccess();return true}$(t).html("请选择支付方式").prop("disabled",false);currentOrder=e.data;showPayDialog(currentOrder)}else{alert("保存失败:"+(e.message||e.msg));history.go(-1);loadDistributionModeDiv(getSelectDate()==null?"":getSelectDate().day);$(t).prop("disabled",false)}},function(){loaded("body");alert("服务器出错！");$(t).prop("disabled",false)})}function showPayDialog(t){$("#payment-dialog").setAjaxParam(t);$("#payment-dialog").find(".confrim-payment").unbind();$("#payment-dialog").find(".confrim-payment").click(function(){payOrder(t.ORDER_ID,this)});$("#payment-dialog").show()}function tangshiPayment(){$("#tangshiForm").html("");$("#tangshiForm").append(createInput("DISTRIBUTION_MODE_ID",DISTRIBUTION_MODE_ID));$("#tangshiForm").submit()}function createInput(t,e){var i=$("<input />");i.attr("name",t);i.val(e);return i}var currentOrder;function loadDistributionModeDiv(t){currentOrder=null;var e="";if(t&&DISTRIBUTION_MODE_ID==2){e="/article/weixin/listAllArticlesByDistributionId?DISTRIBUTION_MODE_ID="+DISTRIBUTION_MODE_ID+"&DISTRIBUTION_DATE="+t}else{e="/article/weixin/listAllArticlesByDistributionId?DISTRIBUTION_MODE_ID="+DISTRIBUTION_MODE_ID}cAjax("wx/server",{p:encodeURI(e)},function(t){var e=t.list;articleListMap.clear();articlesMap.clear();for(var i in e){var a=e[i];if(a.NOT_SUPPLY||a.ISEMPTY){a.ARTICLEFAMILY_ID=-1}else if(DISTRIBUTION_MODE_ID==2&&a.REMAIN_NUMBER<=0){a.ARTICLEFAMILY_ID=-1}var r=a.ARTICLEFAMILY_ID;if(articleListMap.containsKey(r)){articleListMap.get(r).push(a)}else{var n=new Array;n.push(a);articleListMap.put(r,n)}articlesMap.put(a.ARTICLE_ID,a)}initShopCart()});var i=currentModeDiv.find(".show-shop-cart");i.unbind();i.click(function(){showShopCartDialog()})}function appraiseOrder(t){var e=$(t).parents(".order-item").data("id");location.href="wx/informationEvaluate?ORDER_ID="+e}function showShopCartDialog(){var t=getShopCartItems();for(var e in t){var i=t[e];var a=i.find(".minusNumber").removeAttr("onclick");a.click(function(){paymentCut(this,function(){showShopCartDialog()})})}$("#shop-cart-dialog").show();if(t.length){var r=$("<ul></ul");r.html(t);var n=$("#shop-cart-dialog").find(".shop-cart-items").html(r).get(0);var o=new IScroll(n)}else{$("#shop-cart-dialog").find(".shop-cart-items").html("<p class='empty'>"+"<i class=' icon-shopping-cart'></i>"+"<span>购物车内还没有商品</span>"+"</p>")}}function initShopCart(){cAjax("wx/listCartDetailByUserId",{DISTRIBUTION_MODE_ID:DISTRIBUTION_MODE_ID},function(t){var e=t.list;shopCart&&shopCart.clear();for(var i in e){var a=e[i];var r=articlesMap.get(a.ARTICLE_ID);if(!r||r.ISEMPTY||r.NOT_SUPPLY){continue}if(DISTRIBUTION_MODE_ID==2&&r.REMAIN_NUMBER<=0){continue}shopCart.add(r,a.QTY)}initArticleFamily();updateAmoutPriview()})}function initIsc(){frameInit();if(w_FamListIsc){setTimeout(function(){w_FamListIsc.refresh();w_ArtListIsc.refresh();t_FamListIsc.refresh();t_ArtListIsc.refresh()},200)}}function initArticleFamily(){cAjax("wx/server",{p:"/articlefamily/weixin/getAllAppArticleFamilys.do"},function(t){var e=currentModeDiv.find(".choice-div");e.hide();var i=currentModeDiv.find(".article-div");var a=t.list;i.find(".article-family-list").html("");i.find(".article-list").html("");a.push({ARTICLEFAMILY_ID:"-1",LEVEL:"1",NAME:"已售罄"});for(var r in a){var n=a[r];var o=getTmpl(".art-fam-item");o.find(".art-fam-name").html(n.NAME);o.attr("data-id",n.ARTICLEFAMILY_ID);var l=articleListMap.get(n.ARTICLEFAMILY_ID);if(l){addArtsToArticleListDom(l);i.find(".article-family-list").append(o);o.click(function(){showToArticles(this)})}}i.show();currentModeDiv.find(".art-fam-item").first().click();initIsc();i.find(".article-list").scroll(function(t){var e=null;var i=$(".menuLogo").height();$(this).find(".art-item").each(function(){var t=$(this).offset().top-i;if(t<=0){e=$(this)}else{return false}});if(!e){return false}var a=e.attr("data-family");var r=currentModeDiv.find(".article-family-list").find(".active");if(r.data("id")==a){return true}else{var n=currentModeDiv.find(".article-family-list").find("[data-id='"+a+"']");n.addClass("active");r.removeClass("active")}})})}function showArticleDetails(t){var e=$(t).parents(".art-item");var i=e.data("id");showArticleDialogById(i)}function showArticleDialogById(t,e){cAjax("wx/server",{p:"/article/weixin/getArticleInfo?ARTICLE_ID="+t},function(e){var i=$("#food-dialog").clone();i.attr("id","");i.find(".dialog-close").click(function(){$(this).parents(".custom-dialog").remove()});i.find(".art-item").attr("data-id",t);var a=findArtItemById(t);i.find(".foodList-content-price").html(a.find(".numberControl").clone());var r=e.data;r.DESCRIPTION=r.DESCRIPTION.replace(/\n/g,"<br/>");if(noticleList.length>0){var n=Math.floor(Math.random()*noticleList.length);r.TITLE=noticleList[n].TITLE;i.find("[data-key='TITLE']").show()}else{i.find("[data-key='TITLE']").hide()}i.setAjaxParam(r);i.appendTo($("body"));i.show()})}function showShopCartToPayTab(){var t=shopCart.getAll();var e=new Array;for(var i in t){var a=t[i];e.push(convertArtToPayArtItem(a))}if(e.length<=0){$("#pay-art-list").html("暂时没有需要支付的选项")}else{$("#pay-art-list").html(e)}}function calculatePayCount(){var t=$("#pay-art-count");t.find(".pay-count-price>span").html(shopCart.getTotalPrice());var e=0;t.find(".pay-express-price>span").html(e);t.find(".pay-should-pay>span").html(shopCart.getTotalPrice()+e)}function calculateActualPayMent(){if($("#order-pay-div").hasClass("active")){var t=0;var e=0;var i=shopCart.getTotalPrice()-t-e;$("#pay-actual").html("￥"+i);return i}else if($("#self-pay-div").hasClass("active")){var a=$("#self-pay-money-input").val();var e=0;var i=a-e;$("#self-pay-money-span").html(i);return a}}function convertArtToPayArtItem(t){var e=getTmpl(".pay-art-item");e.find(".pay-art-number").html(t.number);e.find(".pay-art-name").html(t.NAME);e.find(".pay-price").html(t.PRICE);e.find(".pay-unit").html(t.UNIT);return e}function submitPaySelect(){var t=calculateActualPayMent();$("#do-pay-div").find(".pay-real-price-number").html(t);$("#do-pay-money-input").val("消费总额￥"+t+".00");$("#pay-select-div").hide();$("#do-pay-div").show()}function showPayDetails(){$("#pay-select-div").show();$("#do-pay-div").hide()}function showToArticles(t){var e=$(t).data("id");currentModeDiv.find(".art-fam-item.active").removeClass("active");$(t).addClass("active");var i=currentModeDiv.find(".article-list");var a=i.find("[data-family='"+e+"']").eq(0);var r=a.position().top;t_ArtListIsc.scrollToElement(a.get(0),400,0,1);w_ArtListIsc.scrollTo(0,-r)}function addArtsToArticleListDom(t){currentModeDiv.find(".article-list").append(convertArtArr2ArtItems(t));var e=currentModeDiv.find(".article-list .art-image").width();currentModeDiv.find(".article-list .art-item p").width(e);var i=currentModeDiv.find(".article-list .not-img").attr("src","img/black-img.png");$(".art-image").lazyload({placeholder:"http://www.zioo.top/uploadFiles/uploadImgs/20151210/556bcf70b8834fa3abae3049569aee49.jpg",threshold:400})}function updateArtNumber(t){var e=findArtItemById(t.ARTICLE_ID);e.find(".art-number").html(t.number);if(t.number>0){e.find(".minusNumber").show();e.find(".buyNumber").show()}else{e.find(".buyNumber").hide();e.find(".minusNumber").hide()}}function findArtFamItemById(t){return currentModeDiv.find(".art-fam-item[data-id='"+t+"']")}function findArtItemById(t){return currentModeDiv.find(".art-item[data-id='"+t+"']")}function updateAmoutPriview(){var t=shopCart.getTotalNumber();var e=shopCart.getTotalPrice();currentModeDiv.find(".art-count").html(t);currentModeDiv.find(".art-total-money").html(e)}function ShopCart(){var t=0;var e=0;var i=new HashMap;var a=new HashMap;this.clear=function(){t=0;e=0;i.clear();a.clear()};this.add=function(t,e){if(!e&&e!=0){e=1}r(t,true,e)};this.cut=function(t){r(t,false)};this.addList=function(t){for(var e in t){add(t[e])}};this.getAll=function(){return i.getValues()};this.getTotalPrice=function(){return t};this.getTotalNumber=function(){return e};this.getArticleFamilyNumber=function(t){return a.get(t)};function r(r,n,o){if(currentModeDiv.find(".payment-div:visible").length&&currentOrder){toPayment(true)}currentOrder=null;var l=0;if(a.containsKey(r.ARTICLEFAMILY_ID)){l=a.get(r.ARTICLEFAMILY_ID)}if(n){if(o>r.REMAIN_NUMBER){o=r.REMAIN_NUMBER}if(!r.number||r.number<=0){r.number=o}else{r.number+=o}r.REMAIN_NUMBER-=o;i.put(r.ARTICLE_ID,r);e+=o;t+=Number(r.PRICE)*o;l+=o}else{if(r.number||r.number>0){r.number--;e--;t-=r.PRICE;l--;r.REMAIN_NUMBER++}if(r.number<=0){r.number=0;l=0;i.remove(r.ARTICLE_ID)}}a.put(r.ARTICLEFAMILY_ID,l)}}function paymentAdd(t){var e=$(t).parents(".shopcart-item");var i=$(e).data("id");var a=articlesMap.get(i);if(canAdd(a)){shopCart.add(a);findArtItemById(i).find(".remain-number").html(a.REMAIN_NUMBER);addToCartServer(i,a.number);e.find(".art-number").html(a.number);updateTotalOrder();updateArtNumber(a);updateAmoutPriview()}}function paymentCut(t,e,i){var a=$(t).parents(".shopcart-item");var r=$(a).data("id");var n=articlesMap.get(r);if(n.number>0){shopCart.cut(n);cutToCartServer(r,n.number);a.find(".art-number").html(n.number);updateTotalOrder();updateArtNumber(n);updateAmoutPriview()}if(n.number==0){if(i){i()}else{a.remove()}}if(shopCart.getAll().length==0){if(e){e()}else{history.go(-1)}}findArtItemById(r).find(".remain-number").html(n.REMAIN_NUMBER)}function addArticle2ShopCart(t){var e=$("<span>1</span>");e.css({fontSize:"18px",padding:"0px 10px",backgroundColor:"#CDCDCD",color:"white",borderRadius:"50%",zIndex:99999});var i=currentModeDiv.find(".art-count").offset();var a=$(t).offset();var r=2+2/(i.top-a.top)*20;e.fly({start:{left:a.left,top:a.top},end:{left:i.left,top:i.top},autoPlay:true,speed:r,vertex_Rtop:a.top-50,onEnd:function(){e.remove()}});var n=$(t).parents(".art-item");n.find(".buyNumber").show();n.find(".minusNumber").show();var o=$(n).data("id");var l=articlesMap.get(o);if(canAdd(l)){shopCart.add(l);n.find(".remain-number").html(l.REMAIN_NUMBER);n.find(".art-number").html(l.number);addToCartServer(o,l.number);updateArtNumber(l);updateAmoutPriview()}}function canAdd(t){if(DISTRIBUTION_MODE_ID==2&&t.REMAIN_NUMBER<=0){showMessage("最多就这么多啦，不能再买了");return false}return true}function cutArticleFromShopCart(t){var e=$(t).parents(".art-item");var i=e.data("id");var a=articlesMap.get(i);if(a.number>0){shopCart.cut(a);cutToCartServer(i,a.number);updateArtNumber(a);updateAmoutPriview();if(a.number<=0){e.find(".buyNumber").hide();e.find(".minusNumber").hide()}else{e.find(".art-number").html(a.number)}e.find(".remain-number").html(a.REMAIN_NUMBER)}}function addToCartServer(t,e){updateCartServer(t,e)}function cutToCartServer(t,e){updateCartServer(t,e)}function updateCartServer(t,e){cAjax("wx/updateToShopcart",{ARTICLE_ID:t,DISTRIBUTION_MODE_ID:DISTRIBUTION_MODE_ID,QTY:e},function(t){})}function convertArtArr2ArtItems(t){var e=new Array;for(var i in t){var a=t[i];articlesMap.put(a.ARTICLE_ID,a);var r=getTmpl(".art-item");r.find(".art-name").html(a.NAME);r.find(".art-price").html(a.PRICE);r.find(".art-unit").html(a.UNIT);if(a.PHOTOSMALL){r.find(".art-image").attr("data-original",IMAGE_SERVICE+a.PHOTOSMALL);if(a.PHOTOSMALL){r.attr("data-bigimage",IMAGE_SERVICE+a.PHOTOSMALL)}r.find(".art-image").error(function(){notPicture(r)})}else{notPicture(r)}r.attr("data-id",a.ARTICLE_ID);r.attr("data-family",a.ARTICLEFAMILY_ID);if(DISTRIBUTION_MODE_ID==2&&a.REMAIN_NUMBER<=0&&(!a.number||a.number<=0)){r.find(".numberControl").html("<span class='article-none'>已售罄</span>")}else if(a.ISEMPTY||a.NOT_SUPPLY){r.find(".numberControl").html("<span class='article-none'>已售罄</span>")}else{if(DISTRIBUTION_MODE_ID==2){var n=$("<span class='remain-number'>");n.html(a.REMAIN_NUMBER);r.find(".art-name").html([a.NAME,n])}if(a.number>0){r.find(".art-number").show().html(a.number);r.find(".minusNumber").show();r.find(".buyNumber").show()}else{r.find(".minusNumber").hide();r.find(".buyNumber").hide()}}e.push(r)}return e}function notPicture(t){t.find(".art-image").addClass("not-img").attr("onclick","");t.css({height:100})}function getTmpl(t){return $("#tmpl-div>"+t).clone()}function newCustomer(){cAjax("wx/customerInfo","",function(t){currentCustomer=t;if(!t.BIND_PHONE){newCustomerCoupon()}})}function newCustomerCoupon(){cAjax("wx/listNewCoupon",null,function(t){var e=t.list;e.length&&showNewCustomerModal(e,function(){alert("绑定成功，优惠券已经发放到你的帐户，快到我的中心查看吧！");location.hash="#content-tangshi"})})}function showNewCustomerModal(t,e){var i=$("#welcome-dialog");i.show();i.find(".btn-code").unbind();i.find(".btn-code").click(function(){var t=i.find("[name='PHONE']").val();sendMsg(t,this)});i.find(".dialog-close").unbind();i.find(".dialog-close").click(function(){i.hide()});i.find(".btn-submit").unbind();i.find(".btn-submit").click(function(){$(this).prop("disabled",true);var t=this;var a=i.find("[name='PHONE']").val();var r=i.find("[name='CODE']").val();cAjax("wx/editPhone",{CODE:r,PHONE:a},function(a){if(a.result==1){i.hide();e&&e()}else{i.find(".error").html(a.msg);i.find(".error").parent().show();$(t).prop("disabled",false)}})})}function payOrder(t,e){var i=$("#payment-dialog [name='PAYMENT_MODE_ID']:checked").val();switch(i){case"1":openWechatPay(t,e);break}}function openWechatPay(t,e){loading("body");cAjax("wx/payOrderWx",{ORDER_ID:t},function(t){if(t.NOT_INVENTORY){loaded("body");alert(t.NOT_INVENTORY);loadWaimaiArticles(getSelectDate().day);history.go(-1);return false}if(t.ERROR){loaded("body");alert("错误："+t.ERROR);location.href=location.href;return false}wx.chooseWXPay({timestamp:t.timeStamp,nonceStr:t.nonceStr,"package":t.prepay_id,signType:t.signType,paySign:t.paySign,success:function(t){paySuccess()}});loaded("body")},function(){$(e).html("重新提交")})}function paySuccess(){if(DISTRIBUTION_MODE_ID==2){var t=getSelectDate();alert("请到外卖取餐点 "+deliveryName+new Date(t.day.replace(/-/g,"/")+" "+t.time.time).format("(MM-dd hh:mm)")+" 出示手机尾号"+currentCustomer.TELEPHONE.substr(7)+"，即可领取餐品");location.href="wx/index?i=1#content-information"}else{alert("支付已成功，请到简厨（凌空SOHO店）前台，出示手机尾号"+currentCustomer.TELEPHONE.substr(7)+"，即可消费");location.href="wx/index?i=1#content-information"}}